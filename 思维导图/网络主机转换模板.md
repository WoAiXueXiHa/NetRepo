# InetAddr 类：网络地址封装 (翻译官)

## 1. 核心设计思想
- **目的**：将操作系统复杂的 C 语言结构体 (`struct sockaddr_in`) 封装成易用的 C++ 类。
- **角色**：充当 "人类视角" (string IP, int Port) 与 "机器视角" (二进制 IP, 大端 Port) 之间的**双向翻译官**。
- **原则**：
    - 对内管理 `sockaddr_in` (给系统调用 bind/accept 用)。
    - 对外提供 `std::string` 和 `uint16_t` (给日志和业务逻辑用)。

## 2. 核心成员变量 (Private)
- **`struct sockaddr_in _net_addr`**
    - **地位**：绝对核心，操作系统只认它。
    - **内容**：协议族 (AF_INET), 网络字节序端口, 网络字节序 IP。
- **`std::string _ip`**
    - **作用**：缓存转换后的点分十进制字符串 (如 "127.0.0.1")，用于打印。
- **`uint16_t _port`**
    - **作用**：缓存转换后的主机字节序端口 (如 8080)，用于逻辑判断。

## 3. 两大核心场景 (构造函数)

### 场景 A：我要开店 (Server 监听)
- **方向**：用户输入 -> 网络结构体 (Host -> Net)
- **输入**：端口号 (`uint16_t port`)
- **关键动作**：
    1. `sin_family = AF_INET` (声明 IPv4)。
    2. `sin_port = htons(port)` (主机转网络短整型，**小端转大端**)。
    3. `sin_addr.s_addr = INADDR_ANY` (绑定本机所有网卡，即 0)。
- **结果**：生成一个随时可以被 `bind()` 的结构体。

### 场景 B：客人来了 (Accept 接收连接)
- **方向**：网络结构体 -> 用户可读 (Net -> Host)
- **输入**：`struct sockaddr_in` (由 OS 的 accept 函数填充)
- **关键动作**：
    1. 接管 OS 给的数据：`_net_addr = addr`。
    2. 翻译端口：`_port = ntohs(...)` (网络转主机，**大端转小端**)。
    3. **[易错点]** 翻译 IP：调用 `IpNet2Host()`，将二进制 IP 转为字符串。
- **结果**：生成一个可以用 `Addr()` 打印日志的对象。

## 4. 关键 Helper 函数 (IpNet2Host)
- **功能**：二进制 IP (`sin_addr`) -> 字符串 IP (`string`)
- **核心 API**：`inet_ntop(AF_INET, src, dst, size)`
    - **N**etwork **TO** **P**resentation (网络数值 -> 显示文本)。
- **[重要参数陷阱]**：
    - 第二个参数必须是 `struct in_addr*` 指针 (`&_net_addr.sin_addr`)。
    - **绝对不能**传 `sockaddr_in*`，否则指针偏移量错误，解析出乱码。

## 5. 对外接口 (Public API)
- **`NetAddr()`**
    - **返回**：`struct sockaddr*`
    - **用途**：作为 `bind`, `connect`, `accept` 等系统调用的参数。
    - **转换**：需要强制类型转换 `(struct sockaddr*)&_net_addr`。
- **`NetAddrLen()`**
    - **返回**：结构体大小 (`sizeof`)。
- **`Addr()`**
    - **返回**：`"IP:Port"` 格式字符串。
    - **用途**：打印日志，调试连接信息。

## 6. 知识点总结 & 避坑指南
- **字节序 (Endianness)**
    - 网络规定统一用**大端序 (Big Endian)**。
    - 个人电脑通常是**小端序 (Little Endian)**。
    - **口诀**：发出去用 `h_to_n`，收进来用 `n_to_h`。
- **结构体转换**
    - `sockaddr_in` 是 IPv4 专用。
    - `sockaddr` 是通用接口 (多态基类)。
    - 传参给 OS 时，必须转为通用指针 `(struct sockaddr*)`。
- **构造函数陷阱**
    - 在通过 `sockaddr_in` 构造时，**务必记得手动调用一次 IP 转换逻辑**，否则 `_ip` 成员是空的。